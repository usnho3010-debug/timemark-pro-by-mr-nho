<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Timemark Style Pro</title>
<style>
body{font-family:Arial;background:#f4f4f4;padding:10px}
input,button,label{width:100%;padding:6px;margin:4px 0;font-size:14px}
canvas{max-width:100%;margin-top:10px;border:1px solid #ccc}
.controls{background:#fff;padding:10px;border-radius:8px}
</style>
</head>

<body>

<h3>ğŸ“ Timemark Style Pro</h3>

<div class="controls">
<input type="file" id="imageInput" accept="image/*">

<label>TiÃªu Ä‘á»</label>
<input type="text" id="title" value="Äiá»ƒm danh">

<label>Giá»</label>
<input type="text" id="time">

<label>NgÃ y</label>
<input type="text" id="date">

<label>Äá»‹a Ä‘iá»ƒm â€“ áº¤p / XÃ£ / Huyá»‡n</label>
<input type="text" id="address1"
value="khÃ´ng Ä‘i lÃ m check-in con cáº·c!">

<label>Äá»‹a Ä‘iá»ƒm â€“ Tá»‰nh / ThÃ nh phá»‘</label>
<input type="text" id="address2"
value="VÄ©nh Long">

<button onclick="setNow()">â± Láº¥y giá» hiá»‡n táº¡i</button>
<button onclick="getGPS()">ğŸ“¡ Láº¥y GPS</button>
<button onclick="draw()">ğŸ–Š Táº¡o watermark</button>
<button onclick="download()">â¬‡ï¸ Táº£i áº£nh</button>
</div>

<canvas id="c"></canvas>

<script>
const DAMP = 0.85;
const c = document.getElementById("c");
const ctx = c.getContext("2d");
const imageInput = document.getElementById("imageInput");
let img = new Image();

function fs(p){
  const b=Math.min(c.width,c.height);
  return Math.max(12,Math.round(b*p*DAMP));
}

function roundRect(ctx,x,y,w,h,r){
 ctx.beginPath();
 ctx.moveTo(x+r,y);
 ctx.lineTo(x+w-r,y);
 ctx.quadraticCurveTo(x+w,y,x+w,y+r);
 ctx.lineTo(x+w,y+h-r);
 ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
 ctx.lineTo(x+r,y+h);
 ctx.quadraticCurveTo(x,y+h,x,y+h-r);
 ctx.lineTo(x,y+r);
 ctx.quadraticCurveTo(x,y,x+r,y);
 ctx.closePath();
 ctx.fill();
}

function generateCode(len=12){
 const s="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
 return Array.from({length:len},()=>s[Math.random()*s.length|0]).join("");
}

imageInput.addEventListener("change",e=>{
 const f=e.target.files[0]; if(!f) return;
 const r=new FileReader();
 r.onload=()=>img.src=r.result;
 r.readAsDataURL(f);
});

img.onload=()=>{
 c.width=img.width;
 c.height=img.height;
 ctx.drawImage(img,0,0);
};

function setNow(){
 const n=new Date();
 time.value=n.toLocaleTimeString("vi-VN",{hour:'2-digit',minute:'2-digit'});
 date.value=n.toLocaleDateString("vi-VN",{weekday:'long',day:'numeric',month:'long',year:'numeric'});
}

/* ===== GPS GIá»NG GOOGLE MAPS (KHÃ”NG API KEY) ===== */
function getGPS(){
 if(!navigator.geolocation){
   alert("Thiáº¿t bá»‹ khÃ´ng há»— trá»£ GPS");
   return;
 }

 navigator.geolocation.getCurrentPosition(async pos=>{
   const lat = pos.coords.latitude;
   const lon = pos.coords.longitude;

   try{
     const res = await fetch(
       `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
     );
     const data = await res.json();
     const a = data.address || {};

     // áº¤p / xÃ£ / huyá»‡n
     address1.value = [
       a.hamlet,
       a.village,
       a.suburb,
       a.town,
       a.city_district,
       a.county
     ].filter(Boolean).join(", ");

     // Tá»‰nh / thÃ nh phá»‘
     address2.value = a.state || a.city || "";

   }catch(e){
     alert("KhÃ´ng láº¥y Ä‘Æ°á»£c Ä‘á»‹a chá»‰ tá»« báº£n Ä‘á»“");
   }
 }, ()=>{
   alert("KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­. Vui lÃ²ng báº­t GPS.");
 },{
   enableHighAccuracy:true,
   timeout:10000
 });
}

function draw(){
 if(!img.src) return alert("ChÆ°a chá»n áº£nh");
 ctx.drawImage(img,0,0);

 const pad=fs(0.03);

 const hBox=fs(0.062);
 const hDate=fs(0.036);
 const hAddr=fs(0.030);
 const hCommit=fs(0.034);
 const gap=fs(0.03);

 const totalH=hBox+gap+hDate+hAddr*2+gap+hCommit;
 let y=c.height-totalH-fs(0.04);
 if(y<pad) y=pad;

 /* ===== ÄIá»‚M DANH â€“ GIá»œ ===== */
 ctx.font=`bold ${fs(0.026)}px Arial`;
 const titleW=ctx.measureText(title.value).width+pad*1.6;
 ctx.font=`bold ${fs(0.036)}px Arial`;
 const timeW=ctx.measureText(time.value).width+pad*1.6;

 const r=fs(0.008);
 const totalW=titleW+timeW;

 ctx.fillStyle="#FFFFFF";
 roundRect(ctx,pad,y,totalW,hBox,r);

 ctx.fillStyle="#F6B800";
 ctx.beginPath();
 ctx.moveTo(pad+r,y);
 ctx.lineTo(pad+titleW,y);
 ctx.lineTo(pad+titleW,y+hBox);
 ctx.lineTo(pad+r,y+hBox);
 ctx.quadraticCurveTo(pad,y+hBox,pad,y+hBox-r);
 ctx.lineTo(pad,y+r);
 ctx.quadraticCurveTo(pad,y,pad+r,y);
 ctx.closePath();
 ctx.fill();

 ctx.textAlign="center";
 ctx.fillStyle="#000";
 ctx.font=`bold ${fs(0.026)}px Arial`;
 ctx.fillText(title.value,pad+titleW/2,y+hBox*0.64);

 ctx.fillStyle="#1F4FD8";
 ctx.font=`bold ${fs(0.036)}px Arial`;
 ctx.fillText(time.value,pad+titleW+timeW/2,y+hBox*0.64);
 ctx.textAlign="left";

 y+=hBox+gap;

 /* ===== NGÃ€Y + Äá»ŠA CHá»ˆ ===== */
 const textX=pad+fs(0.03);
 const startY=y;

 ctx.fillStyle="#FFFFFF";
 ctx.font=`bold ${fs(0.032)}px Arial`;
 ctx.fillText(date.value,textX,y);
 y+=hDate;

 ctx.font=`${fs(0.025)}px Arial`;
 if(address1.value){ ctx.fillText(address1.value,textX,y); y+=hAddr; }
 if(address2.value){ ctx.fillText(address2.value,textX,y); y+=hAddr; }

 ctx.fillStyle="#F6B800";
 ctx.fillRect(pad,startY-fs(0.024),fs(0.008),y-startY);

 y+=gap;

 /* ===== CAM Káº¾T ===== */
 ctx.fillStyle="rgba(255,255,255,0.45)";
 ctx.font=`${fs(0.023)}px Arial`;
 ctx.fillText("Cam káº¿t ngÃ y giá» chÃ¢n thá»±c",textX,y);

 /* ===== BRAND ===== */
 ctx.textAlign="right";
 ctx.font=`bold ${fs(0.035)}px Arial`;
 const markW=ctx.measureText("mark").width;
 ctx.fillStyle="#F6B800";
 ctx.fillText("Time",c.width-pad-markW,c.height-pad-fs(0.03));
 ctx.fillStyle="rgba(255,255,255,0.9)";
 ctx.fillText("mark",c.width-pad,c.height-pad-fs(0.03));
 ctx.fillStyle="rgba(255,255,255,0.45)";
 ctx.font=`${fs(0.024)}px Arial`;
 ctx.fillText("100% ChÃ¢n thá»±c",c.width-pad,c.height-pad);
 ctx.textAlign="left";

 /* ===== WATERMARK Dá»ŒC ===== */
 ctx.save();
 ctx.translate(c.width-fs(0.004),c.height/2);
 ctx.rotate(-Math.PI/2);
 ctx.fillStyle="rgba(255,255,255,0.70)";
 ctx.font=`${fs(0.016)}px Arial`;
 ctx.textAlign="center";
 ctx.fillText("â“’ "+generateCode()+" Â· Timemark Verified",0,0);
 ctx.restore();
}

function isIOS(){
 return /iPhone|iPad|iPod/i.test(navigator.userAgent);
}

function download(){
 if(!img.src) return;
 const d=c.toDataURL("image/png");
 if(isIOS()){
  const w=window.open();
  w.document.write(`<img src="${d}" style="max-width:100%">`);
 }else{
  const a=document.createElement("a");
  a.href=d;a.download="timemark-style.png";a.click();
 }
}

setNow();
</script>
</body>
</html>
