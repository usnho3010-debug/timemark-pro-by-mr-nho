<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Timemark Style Pro</title>
<style>
body{font-family:Arial;background:#f4f4f4;padding:10px}
input,button,label{width:100%;padding:6px;margin:4px 0;font-size:14px}
canvas{max-width:100%;margin-top:10px;border:1px solid #ccc}
.controls{background:#fff;padding:10px;border-radius:8px}
</style>
</head>

<body>

<!-- ===== Lá»šP KHÃ“A BÃN LINK (KHÃ”NG áº¢NH HÆ¯á»NG UI) ===== -->
<div id="lockScreen" style="
  position:fixed;
  inset:0;
  background:#f4f4f4;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
">
  <div style="background:#fff;padding:16px;border-radius:10px;max-width:320px;width:100%">
    <h3>ğŸ” KÃ­ch hoáº¡t Timemark</h3>
    <p style="font-size:14px">Vui lÃ²ng sá»­ dá»¥ng link kÃ­ch hoáº¡t do ngÆ°á»i bÃ¡n cung cáº¥p</p>
    <p id="lockMsg" style="color:red;font-size:14px"></p>
  </div>
</div>

<!-- ===== APP TIMEMARK (GIá»® NGUYÃŠN) ===== -->
<div id="appLock">

<h3>ğŸ“ Timemark Style Pro</h3>

<div class="controls">
<input type="file" id="imageInput" accept="image/*">

<label>TiÃªu Ä‘á»</label>
<input type="text" id="title" value="Äiá»ƒm danh">

<label>Giá»</label>
<input type="text" id="time">

<label>NgÃ y</label>
<input type="text" id="date">

<label>Äá»‹a Ä‘iá»ƒm</label>
<input type="text" id="addressInput"
value="Trung Tráº¯c, PhÆ°á»ng 1, TP. Má»¹ Tho, Tiá»n Giang">

<button onclick="setNow()">â± Láº¥y giá» hiá»‡n táº¡i</button>
<button onclick="getGPS()">ğŸ“¡ Láº¥y GPS</button>
<button onclick="draw()">ğŸ–Š Táº¡o watermark</button>
<button onclick="download()">â¬‡ï¸ Táº£i áº£nh</button>
</div>

<canvas id="c"></canvas>

</div>

<script>
/* ======================================================
   ğŸ” QUáº¢N LÃ KEY â€“ CHá»ˆ Sá»¬A PHáº¦N NÃ€Y TRÃŠN GITHUB
   ====================================================== */
const KEY_DB = {
  "nhovip": { expire: "2026-03-31" },
  "tienbiep": { expire: "2026-02-28" }
};
/* ====================================================== */

/* ===== DEVICE ID ===== */
function getDeviceId(){
  let id = localStorage.getItem("tmk_device");
  if(!id){
    id = "DEV-" + Math.random().toString(36).substr(2,10).toUpperCase();
    localStorage.setItem("tmk_device", id);
  }
  return id;
}

/* ===== CHECK ACCESS (BÃN LINK) ===== */
function checkAccess(){
  const params = new URLSearchParams(window.location.search);
  const linkKey = params.get("key");
  const savedKey = localStorage.getItem("tmk_key");
  const device = getDeviceId();
  const today = new Date().toISOString().slice(0,10);

  const key = linkKey || savedKey;
  if(!key || !KEY_DB[key]){
    deny("Key khÃ´ng há»£p lá»‡");
    return;
  }

  if(today > KEY_DB[key].expire){
    deny("Key Ä‘Ã£ háº¿t háº¡n");
    return;
  }

  const usedDevice = localStorage.getItem("tmk_key_device");
  if(usedDevice && usedDevice !== device){
    deny("Key Ä‘Ã£ Ä‘Æ°á»£c kÃ­ch hoáº¡t trÃªn thiáº¿t bá»‹ khÃ¡c");
    return;
  }

  localStorage.setItem("tmk_key", key);
  localStorage.setItem("tmk_key_device", device);

  unlock();

  if(linkKey){
    history.replaceState({}, document.title, location.pathname);
  }
}

function unlock(){
  document.getElementById("lockScreen").style.display="none";
  document.getElementById("appLock").style.display="block";
}

function deny(msg){
  document.getElementById("lockMsg").innerText = msg;
  document.getElementById("appLock").style.display="none";
}

/* ===== KÃCH HOáº T NGAY ===== */
checkAccess();

/* ================= CONFIG ================= */
const DAMP = 0.85;

/* ================= INIT ================= */
const c = document.getElementById("c");
const ctx = c.getContext("2d");
const imageInput = document.getElementById("imageInput");
let img = new Image();

/* ================= SCALE ================= */
function fs(pct){
  const base = Math.min(c.width, c.height);
  return Math.max(14, Math.min(64, Math.round(base * pct * DAMP)));
}

/* ================= UTILS ================= */
function roundRect(ctx,x,y,w,h,r,fill){
 ctx.beginPath();
 ctx.moveTo(x+r,y);
 ctx.lineTo(x+w-r,y);
 ctx.quadraticCurveTo(x+w,y,x+w,y+r);
 ctx.lineTo(x+w,y+h-r);
 ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
 ctx.lineTo(x+r,y+h);
 ctx.quadraticCurveTo(x,y+h,x,y+h-r);
 ctx.lineTo(x,y+r);
 ctx.quadraticCurveTo(x,y,x+r,y);
 ctx.closePath();
 if(fill) ctx.fill();
}

function generateCode(len=14){
 const s="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
 return Array.from({length:len},()=>s[Math.random()*s.length|0]).join("");
}

/* ================= LOAD IMAGE ================= */
imageInput.addEventListener("change", e=>{
 const file = e.target.files[0];
 if(!file) return;
 const r = new FileReader();
 r.onload = ()=> img.src = r.result;
 r.readAsDataURL(file);
});

img.onload = ()=>{
 c.width = img.width;
 c.height = img.height;
 ctx.drawImage(img,0,0);
};

/* ================= TIME ================= */
function setNow(){
 const n = new Date();
 time.value = n.toLocaleTimeString("vi-VN",{hour:'2-digit',minute:'2-digit'});
 date.value = n.toLocaleDateString("vi-VN",{weekday:'long',day:'numeric',month:'long',year:'numeric'});
}

/* ================= GPS ================= */
function getGPS(){
 navigator.geolocation.getCurrentPosition(p=>{
  addressInput.value =
   `Lat ${p.coords.latitude.toFixed(5)}, Lng ${p.coords.longitude.toFixed(5)}`;
 });
}

/* ================= DRAW ================= */
function draw(){
 if(!img.src) return alert("Vui lÃ²ng chá»n áº£nh trÆ°á»›c");

 ctx.drawImage(img,0,0);

 const pad = fs(0.03);
 const boxX = pad;

 const infoHeight =
   fs(0.075)+fs(0.04)+fs(0.03)+fs(0.04)+fs(0.05)+fs(0.05);

 let cursorY = c.height - infoHeight - fs(0.04);
 if(cursorY < pad) cursorY = pad;

 ctx.font = `bold ${fs(0.035)}px Arial`;
 const titleW = ctx.measureText(title.value).width + pad*2;
 ctx.font = `bold ${fs(0.045)}px Arial`;
 const timeW = ctx.measureText(time.value).width + pad*2;
 const boxH = fs(0.075);

 ctx.fillStyle="#fff";
 roundRect(ctx,boxX,cursorY,titleW+timeW,boxH,fs(0.02),true);
 ctx.fillStyle="#FFC107";
 roundRect(ctx,boxX,cursorY,titleW,boxH,fs(0.02),true);
 ctx.fillStyle="#1E88E5";
 roundRect(ctx,boxX+titleW,cursorY,timeW,boxH,fs(0.02),true);

 ctx.textAlign="center";
 ctx.fillStyle="#000";
 ctx.font=`bold ${fs(0.035)}px Arial`;
 ctx.fillText(title.value,boxX+titleW/2,cursorY+boxH*0.68);
 ctx.fillStyle="#fff";
 ctx.font=`bold ${fs(0.045)}px Arial`;
 ctx.fillText(time.value,boxX+titleW+timeW/2,cursorY+boxH*0.72);
 ctx.textAlign="left";

 cursorY+=boxH+fs(0.04);

 ctx.fillStyle="#fff";
 ctx.font=`${fs(0.03)}px Arial`;
 ctx.fillText(date.value,boxX,cursorY);
 cursorY+=fs(0.04);

 if(addressInput.value.trim()){
  ctx.fillStyle="#FFC107";
  ctx.fillRect(boxX,cursorY-fs(0.028),fs(0.008),fs(0.05));
  ctx.fillStyle="#fff";
  ctx.font=`${fs(0.028)}px Arial`;
  ctx.fillText(addressInput.value,boxX+fs(0.025),cursorY);
  cursorY+=fs(0.05);
 }

 ctx.fillStyle="rgba(255,255,255,0.45)";
 ctx.font=`${fs(0.022)}px Arial`;
 ctx.fillText("âœ“", pad+fs(0.015), cursorY);
 ctx.font=`${fs(0.023)}px Arial`;
 ctx.fillText("Cam káº¿t ngÃ y giá» chÃ¢n thá»±c", boxX+fs(0.05), cursorY);

 ctx.textAlign="right";
 ctx.font=`bold ${fs(0.035)}px Arial`;
 const markW=ctx.measureText("mark").width;
 ctx.fillStyle="#FFC107";
 ctx.fillText("Time",c.width-pad-markW,c.height-pad-fs(0.03));
 ctx.fillStyle="rgba(255,255,255,0.9)";
 ctx.fillText("mark",c.width-pad,c.height-pad-fs(0.03));
 ctx.fillStyle="rgba(255,255,255,0.45)";
 ctx.font=`${fs(0.024)}px Arial`;
 ctx.fillText("100% ChÃ¢n thá»±c",c.width-pad,c.height-pad);
 ctx.textAlign="left";

 ctx.save();
 ctx.translate(c.width-fs(0.02),c.height/2);
 ctx.rotate(-Math.PI/2);
 ctx.fillStyle="rgba(255,255,255,0.85)";
 ctx.font=`${fs(0.025)}px Arial`;
 ctx.textAlign="center";
 ctx.fillText("â“’ "+generateCode()+" Â· Timemark Verified",0,0);
 ctx.restore();
}

/* ================= DOWNLOAD ================= */
function download(){
 if(!img.src) return;
 const a=document.createElement("a");
 a.download="timemark-style.png";
 a.href=c.toDataURL("image/png");
 a.click();
}

setNow();
</script>
</body>
</html>

