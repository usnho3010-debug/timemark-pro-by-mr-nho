<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Timemark Style Pro</title>
<style>
body{font-family:Arial;background:#f4f4f4;padding:10px}
input,button,label{width:100%;padding:6px;margin:4px 0;font-size:14px}
canvas{max-width:100%;margin-top:10px;border:1px solid #ccc}
.controls{background:#fff;padding:10px;border-radius:8px}
</style>
</head>

<body>

<h3>üìç Timemark Style Pro</h3>

<div class="controls">
<input type="file" id="imageInput" accept="image/*">

<label>Ti√™u ƒë·ªÅ</label>
<input type="text" id="title" value="ƒêi·ªÉm danh">

<label>Gi·ªù</label>
<input type="text" id="time">

<label>Ng√†y</label>
<input type="text" id="date">

<label>ƒê·ªãa ƒëi·ªÉm</label>
<input type="text" id="addressInput"
value="Trung Tr·∫Øc, Ph∆∞·ªùng 1, TP. M·ªπ Tho, Ti·ªÅn Giang">

<button onclick="setNow()">‚è± L·∫•y gi·ªù hi·ªán t·∫°i</button>
<button onclick="getGPS()">üì° L·∫•y GPS</button>
<button onclick="draw()">üñä T·∫°o watermark</button>
<button onclick="download()">‚¨áÔ∏è T·∫£i ·∫£nh</button>
</div>

<canvas id="c"></canvas>

<script>
const DAMP = 0.85;
const c = document.getElementById("c");
const ctx = c.getContext("2d");
const imageInput = document.getElementById("imageInput");
let img = new Image();

function fs(p){
  const b=Math.min(c.width,c.height);
  return Math.max(12,Math.round(b*p*DAMP));
}

function roundRect(ctx,x,y,w,h,r){
 ctx.beginPath();
 ctx.moveTo(x+r,y);
 ctx.lineTo(x+w-r,y);
 ctx.quadraticCurveTo(x+w,y,x+w,y+r);
 ctx.lineTo(x+w,y+h-r);
 ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
 ctx.lineTo(x+r,y+h);
 ctx.quadraticCurveTo(x,y+h,x,y+h-r);
 ctx.lineTo(x,y+r);
 ctx.quadraticCurveTo(x,y,x+r,y);
 ctx.closePath();
 ctx.fill();
}

function generateCode(len=12){
 const s="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
 return Array.from({length:len},()=>s[Math.random()*s.length|0]).join("");
}

imageInput.addEventListener("change",e=>{
 const f=e.target.files[0]; if(!f) return;
 const r=new FileReader();
 r.onload=()=>img.src=r.result;
 r.readAsDataURL(f);
});

img.onload=()=>{
 c.width=img.width;
 c.height=img.height;
 ctx.drawImage(img,0,0);
};

function setNow(){
 const n=new Date();
 time.value=n.toLocaleTimeString("vi-VN",{hour:'2-digit',minute:'2-digit'});
 date.value=n.toLocaleDateString("vi-VN",{weekday:'long',day:'numeric',month:'long',year:'numeric'});
}

function getGPS(){
 addressInput.value="Trung Tr·∫Øc, Ph∆∞·ªùng 1, TP. M·ªπ Tho, Ti·ªÅn Giang";
}

function draw(){
 if(!img.src) return alert("Ch∆∞a ch·ªçn ·∫£nh");
 ctx.drawImage(img,0,0);

 const pad=fs(0.03);

 /* ===== GI·∫¢M KH·ªêI M√ÄU ~5% + TƒÇNG KHO·∫¢NG TH·ªû ===== */
 const hBox=fs(0.062);          // ‚Üì 5%
 const hDate=fs(0.035);
 const hAddr=fs(0.045);
 const hCommit=fs(0.035);
 const gap=fs(0.028);           // ‚Üë gi√£n d·ªçc

 const totalH=hBox+gap+hDate+hAddr+gap+hCommit;
 let y=c.height-totalH-fs(0.04);
 if(y<pad) y=pad;

 /* ===== ƒêI·ªÇM DANH ‚Äì GI·ªú ===== */
 ctx.font=`bold ${fs(0.027)}px Arial`;
 const titleW=ctx.measureText(title.value).width+pad*1.6;

 ctx.font=`bold ${fs(0.035)}px Arial`;
 const timeW=ctx.measureText(time.value).width+pad*1.6;

 const r=fs(0.004);

 ctx.fillStyle="#FFC107";
 roundRect(ctx,pad,y,titleW,hBox,r);

 ctx.fillStyle="#1E88E5";
 roundRect(ctx,pad+titleW-1,y,timeW+1,hBox,r);

 ctx.textAlign="center";

 ctx.fillStyle="#000";
 ctx.font=`bold ${fs(0.027)}px Arial`;
 ctx.fillText(title.value,pad+titleW/2,y+hBox*0.62);

 ctx.fillStyle="#fff";
 ctx.font=`bold ${fs(0.035)}px Arial`;
 ctx.fillText(time.value,pad+titleW+timeW/2,y+hBox*0.62);

 ctx.textAlign="left";
 y+=hBox+gap;

 /* ===== NG√ÄY + ƒê·ªäA CH·ªà (KH√îNG ƒê√à) ===== */
 const textX=pad+fs(0.03);
 ctx.fillStyle="#FFC107";
 ctx.fillRect(pad,y-fs(0.025),fs(0.008),hDate+hAddr);

 ctx.fillStyle="#fff";
 ctx.font=`${fs(0.03)}px Arial`;
 ctx.fillText(date.value,textX,y);
 y+=hDate;

 ctx.font=`${fs(0.028)}px Arial`;
 ctx.fillText(addressInput.value,textX,y);
 y+=hAddr+gap;

 /* ===== CAM K·∫æT (THO√ÅNG) ===== */
 ctx.fillStyle="rgba(255,255,255,0.45)";
 ctx.font=`${fs(0.022)}px Arial`;
 ctx.fillText("‚úì",pad+fs(0.01),y);
 ctx.font=`${fs(0.023)}px Arial`;
 ctx.fillText("Cam k·∫øt ng√†y gi·ªù ch√¢n th·ª±c",textX,y);

 /* ===== BRAND ===== */
 ctx.textAlign="right";
 ctx.font=`bold ${fs(0.035)}px Arial`;
 const markW=ctx.measureText("mark").width;
 ctx.fillStyle="#FFC107";
 ctx.fillText("Time",c.width-pad-markW,c.height-pad-fs(0.03));
 ctx.fillStyle="rgba(255,255,255,0.9)";
 ctx.fillText("mark",c.width-pad,c.height-pad-fs(0.03));
 ctx.fillStyle="rgba(255,255,255,0.45)";
 ctx.font=`${fs(0.024)}px Arial`;
 ctx.fillText("100% Ch√¢n th·ª±c",c.width-pad,c.height-pad);
 ctx.textAlign="left";

 /* ===== WATERMARK D·ªåC ===== */
 ctx.save();
 ctx.translate(c.width-fs(0.006),c.height/2);
 ctx.rotate(-Math.PI/2);
 ctx.fillStyle="rgba(255,255,255,0.65)";
 ctx.font=`${fs(0.017)}px Arial`;
 ctx.textAlign="center";
 ctx.fillText("‚ìí "+generateCode()+" ¬∑ Timemark Verified",0,0);
 ctx.restore();
}

function isIOS(){
 return /iPhone|iPad|iPod/i.test(navigator.userAgent);
}

function download(){
 if(!img.src) return;
 const d=c.toDataURL("image/png");
 if(isIOS()){
  const w=window.open();
  w.document.write(`<img src="${d}" style="max-width:100%">`);
 }else{
  const a=document.createElement("a");
  a.href=d;a.download="timemark-style.png";a.click();
 }
}

setNow();
</script>
</body>
</html>
