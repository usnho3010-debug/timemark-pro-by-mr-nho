<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Timemark Style Pro</title>
<style>
body{font-family:Arial;background:#f4f4f4;padding:10px}
input,button,label{width:100%;padding:6px;margin:4px 0;font-size:14px}
canvas{max-width:100%;margin-top:10px;border:1px solid #ccc}
.controls{background:#fff;padding:10px;border-radius:8px}
</style>
</head>

<body>

<h3>üìç Timemark Style Pro</h3>

<div class="controls">
<input type="file" id="imageInput" accept="image/*">

<label>Ti√™u ƒë·ªÅ</label>
<input type="text" id="title" value="ƒêi·ªÉm danh">

<label>Gi·ªù</label>
<input type="text" id="time">

<label>Ng√†y</label>
<input type="text" id="date">

<label>ƒê·ªãa ƒëi·ªÉm</label>
<input type="text" id="addressInput"
value="Trung Tr·∫Øc, Ph∆∞·ªùng 1, TP. M·ªπ Tho, Ti·ªÅn Giang">

<button onclick="setNow()">‚è± L·∫•y gi·ªù hi·ªán t·∫°i</button>
<button onclick="getGPS()">üì° L·∫•y GPS</button>
<button onclick="draw()">üñä T·∫°o watermark</button>
<button onclick="download()">‚¨áÔ∏è T·∫£i ·∫£nh</button>
</div>

<canvas id="c"></canvas>

<script>
/* ================= CONFIG ================= */
const DAMP = 0.85;

/* ================= INIT ================= */
const c = document.getElementById("c");
const ctx = c.getContext("2d");
const imageInput = document.getElementById("imageInput");
let img = new Image();

/* ================= SCALE ================= */
function fs(pct){
  const base = Math.min(c.width, c.height);
  return Math.max(14, Math.min(64, Math.round(base * pct * DAMP)));
}

/* ================= UTILS ================= */
function roundRect(ctx,x,y,w,h,r,fill){
 ctx.beginPath();
 ctx.moveTo(x+r,y);
 ctx.lineTo(x+w-r,y);
 ctx.quadraticCurveTo(x+w,y,x+w,y+r);
 ctx.lineTo(x+w,y+h-r);
 ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
 ctx.lineTo(x+r,y+h);
 ctx.quadraticCurveTo(x,y+h,x,y+h-r);
 ctx.lineTo(x,y+r);
 ctx.quadraticCurveTo(x,y,x+r,y);
 ctx.closePath();
 if(fill) ctx.fill();
}

function generateCode(len=14){
 const s="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
 return Array.from({length:len},()=>s[Math.random()*s.length|0]).join("");
}

/* ================= LOAD IMAGE ================= */
imageInput.addEventListener("change", e=>{
 const file = e.target.files[0];
 if(!file) return;
 const r = new FileReader();
 r.onload = ()=> img.src = r.result;
 r.readAsDataURL(file);
});

img.onload = ()=>{
 c.width = img.width;
 c.height = img.height;
 ctx.drawImage(img,0,0);
};

/* ================= TIME ================= */
function setNow(){
 const n = new Date();
 time.value = n.toLocaleTimeString("vi-VN",{hour:'2-digit',minute:'2-digit'});
 date.value = n.toLocaleDateString("vi-VN",{weekday:'long',day:'numeric',month:'long',year:'numeric'});
}

/* ================= GPS ================= */
function getGPS(){
 navigator.geolocation.getCurrentPosition(p=>{
  addressInput.value =
   `Lat ${p.coords.latitude.toFixed(5)}, Lng ${p.coords.longitude.toFixed(5)}`;
 });
}

/* ================= DRAW ================= */
function draw(){
 if(!img.src) return alert("Vui l√≤ng ch·ªçn ·∫£nh tr∆∞·ªõc");

 ctx.drawImage(img,0,0);

 const pad = fs(0.03);
 const boxX = pad;

 const infoHeight =
   fs(0.075)+fs(0.04)+fs(0.03)+fs(0.04)+fs(0.05)+fs(0.05);

 let cursorY = c.height - infoHeight - fs(0.04);
 if(cursorY < pad) cursorY = pad;

 ctx.font = `bold ${fs(0.035)}px Arial`;
 const titleW = ctx.measureText(title.value).width + pad*2;
 ctx.font = `bold ${fs(0.045)}px Arial`;
 const timeW = ctx.measureText(time.value).width + pad*2;
 const boxH = fs(0.075);

 ctx.fillStyle="#fff";
 roundRect(ctx,boxX,cursorY,titleW+timeW,boxH,fs(0.02),true);
 ctx.fillStyle="#FFC107";
 roundRect(ctx,boxX,cursorY,titleW,boxH,fs(0.02),true);
 ctx.fillStyle="#1E88E5";
 roundRect(ctx,boxX+titleW,cursorY,timeW,boxH,fs(0.02),true);

 ctx.textAlign="center";
 ctx.fillStyle="#000";
 ctx.font=`bold ${fs(0.035)}px Arial`;
 ctx.fillText(title.value,boxX+titleW/2,cursorY+boxH*0.68);
 ctx.fillStyle="#fff";
 ctx.font=`bold ${fs(0.045)}px Arial`;
 ctx.fillText(time.value,boxX+titleW+timeW/2,cursorY+boxH*0.72);
 ctx.textAlign="left";

 cursorY+=boxH+fs(0.04);

 ctx.fillStyle="#fff";
 ctx.font=`${fs(0.03)}px Arial`;
 ctx.fillText(date.value,boxX,cursorY);
 cursorY+=fs(0.04);

 if(addressInput.value.trim()){
  ctx.fillStyle="#FFC107";
  ctx.fillRect(boxX,cursorY-fs(0.028),fs(0.008),fs(0.05));
  ctx.fillStyle="#fff";
  ctx.font=`${fs(0.028)}px Arial`;
  ctx.fillText(addressInput.value,boxX+fs(0.025),cursorY);
  cursorY+=fs(0.05);
 }

 ctx.fillStyle="rgba(255,255,255,0.45)";
 ctx.font=`${fs(0.022)}px Arial`;
 ctx.fillText("‚úì", pad+fs(0.015), cursorY);
 ctx.font=`${fs(0.023)}px Arial`;
 ctx.fillText("Cam k·∫øt ng√†y gi·ªù ch√¢n th·ª±c", boxX+fs(0.05), cursorY);

 ctx.textAlign="right";
 ctx.font=`bold ${fs(0.035)}px Arial`;
 const markW=ctx.measureText("mark").width;
 ctx.fillStyle="#FFC107";
 ctx.fillText("Time",c.width-pad-markW,c.height-pad-fs(0.03));
 ctx.fillStyle="rgba(255,255,255,0.9)";
 ctx.fillText("mark",c.width-pad,c.height-pad-fs(0.03));
 ctx.fillStyle="rgba(255,255,255,0.45)";
 ctx.font=`${fs(0.024)}px Arial`;
 ctx.fillText("100% Ch√¢n th·ª±c",c.width-pad,c.height-pad);
 ctx.textAlign="left";

 ctx.save();
 ctx.translate(c.width-fs(0.02),c.height/2);
 ctx.rotate(-Math.PI/2);
 ctx.fillStyle="rgba(255,255,255,0.85)";
 ctx.font=`${fs(0.025)}px Arial`;
 ctx.textAlign="center";
 ctx.fillText("‚ìí "+generateCode()+" ¬∑ Timemark Verified",0,0);
 ctx.restore();
}

/* ================= DOWNLOAD IOS + ANDROID ================= */
function isIOS(){
  return /iPhone|iPad|iPod/i.test(navigator.userAgent);
}

function download(){
  if(!img.src) return;

  const dataURL = c.toDataURL("image/png");

  if(isIOS()){
    const win = window.open();
    win.document.write(`
      <html>
        <head>
          <meta name="viewport" content="width=device-width, initial-scale=1">
        </head>
        <body style="margin:0;background:#000;text-align:center">
          <p style="color:#fff;font-size:14px">
            Nh·∫•n gi·ªØ ·∫£nh ‚Üí L∆∞u v√†o ·∫¢nh
          </p>
          <img src="${dataURL}" style="max-width:100%">
        </body>
      </html>
    `);
  }else{
    const a=document.createElement("a");
    a.href=dataURL;
    a.download="timemark-style.png";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
}

setNow();
</script>

</body>
</html>
